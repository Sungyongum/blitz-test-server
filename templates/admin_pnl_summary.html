<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ê´€ë¦¬ì ì†ìµ í˜„í™© - Blitz Trade Bot</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { background:#121212; color:#fff; }
    .card { background:#1e1e1e; border:none; }
    .highlight { color:#00ff99; font-weight:700; }
    .chart-container { position:relative; height:300px; }
    .btn-link { color:#00ff99; text-decoration:none; font-weight:700; margin-bottom:20px; display:inline-block; }
    select, option { color:#000; }
  </style>
</head>
<body class="container py-4">

  <div class="d-flex align-items-center mb-4">
    <img src="{{ url_for('static', filename='logo.png') }}" alt="ë¡œê³ " style="height: 40px; margin-right: 10px;">
    <h2 class="mb-0">ğŸ‘‘ ê´€ë¦¬ì ì†ìµ í˜„í™©</h2>
  </div>

  <a href="{{ url_for('main.index') }}" class="btn-link">â† ëŒ€ì‹œë³´ë“œë¡œ ëŒì•„ê°€ê¸°</a>

  <!-- ìœ ì € ì„ íƒ -->
  <form method="get" class="mb-3 d-flex gap-2">
    <select class="form-select w-auto" name="user_id" onchange="this.form.submit()">
      {% for u in users %}
        <option value="{{ u.id }}" {% if selected_user and u.id == selected_user.id %}selected{% endif %}>
          {{ u.email or ('User ' ~ u.id) }}
        </option>
      {% endfor %}
    </select>
    <noscript><button class="btn btn-sm btn-success">ì¡°íšŒ</button></noscript>
  </form>

  <div class="mb-2">
    <small class="text-muted">ì„ íƒëœ ìœ ì €: <b>{{ selected_user.email if selected_user else '' }}</b> (ID: {{ selected_user.id if selected_user else '' }})</small>
  </div>

  <!-- ìš”ì•½ ì¹´ë“œ -->
  <div class="row g-4 mb-4">
    <div class="col-md-3">
      <div class="card p-3">
        <h5 class="card-title">ì´ ìˆ˜ìµ</h5>
        <p class="card-text highlight" id="total-profit">
          {{ total_profit if total_profit is defined else 0 }} USDT
        </p>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card p-3">
        <h5 class="card-title">ì´ ê±°ë˜</h5>
        <p class="card-text highlight" id="total-trades">0 íšŒ</p>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card p-3">
        <h5 class="card-title">ìŠ¹ë¥ </h5>
        <p class="card-text highlight" id="win-rate">0%</p>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card p-3">
        <h5 class="card-title">í‰ê·  ìˆ˜ìµ</h5>
        <p class="card-text highlight" id="avg-profit">0 USDT</p>
      </div>
    </div>
  </div>

  <div class="row">
    <div class="col-md-8">
      <div class="card p-3">
        <h5 class="card-title">ğŸ“Š ì¼ë³„ ì†ìµ ê·¸ë˜í”„</h5>
        <div class="chart-container"><canvas id="pnlChart"></canvas></div>
      </div>
    </div>
    <div class="col-md-4">
      <div class="card p-3">
        <h5 class="card-title">âœ… ê±°ë˜ ìš”ì•½</h5>
        <table class="table table-sm">
          <thead><tr><th>ë‚ ì§œ</th><th>ì†ìµ</th><th>ê±°ë˜ìˆ˜</th></tr></thead>
          <tbody id="summary-table"></tbody>
        </table>
      </div>
    </div>
  </div>

  <script id="admin-pnl-data" type="application/json">{{ data|tojson|safe }}</script>

  <script>
    // ì—ë””í„° ì¹œí™”ì : ëŸ°íƒ€ì„ì— JSONë§Œ íŒŒì‹±
    const raw = document.getElementById('admin-pnl-data')?.textContent || '[]';
    let sampleData;
    try { sampleData = JSON.parse(raw) || []; } catch { sampleData = []; }

    const totalProfitRaw = sampleData.reduce((a, b) => a + (b.pnl || 0), 0);
    const totalTrades    = sampleData.reduce((a, b) => a + (b.trades || 0), 0);
    const days           = sampleData.length || 1;
    const winDays        = sampleData.filter(d => (d.pnl || 0) > 0).length;

    const totalProfit = totalProfitRaw.toFixed(2);
    const avgProfit   = (totalProfitRaw / days).toFixed(2);
    const winRate     = ((winDays / days) * 100).toFixed(1);

    document.getElementById('total-profit').innerText = totalProfit + ' USDT';
    document.getElementById('total-trades').innerText = totalTrades + ' íšŒ';
    document.getElementById('win-rate').innerText     = winRate + '%';
    document.getElementById('avg-profit').innerText   = avgProfit + ' USDT';

    const ctx = document.getElementById('pnlChart').getContext('2d');
    new Chart(ctx, {
      type: 'bar',
      data: {
        labels: sampleData.map(d => d.date),
        datasets: [{ label: 'ì†ìµ (USDT)', data: sampleData.map(d => d.pnl) }]
      },
      options: { scales: { y: { beginAtZero: true } } }
    });

    const tbody = document.getElementById('summary-table');
    sampleData.forEach(row => {
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${row.date}</td><td>${(row.pnl ?? 0).toFixed(2)}</td><td>${row.trades ?? 0}</td>`;
      tbody.appendChild(tr);
    });
  </script>
</body>
</html>
