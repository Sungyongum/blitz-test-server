<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>관리자 손익 현황 - Blitz Trade Bot</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { background:#121212; color:#fff; }
    .card { background:#1e1e1e; border:none; }
    .highlight { color:#00ff99; font-weight:700; }
    .chart-container { position:relative; height:300px; }
    .btn-link { color:#00ff99; text-decoration:none; font-weight:700; margin-bottom:20px; display:inline-block; }
    select, option { color:#000; }
  </style>
</head>
<body class="container py-4">

  <div class="d-flex align-items-center mb-4">
    <img src="{{ url_for('static', filename='logo.png') }}" alt="로고" style="height: 40px; margin-right: 10px;">
    <h2 class="mb-0">👑 관리자 손익 현황</h2>
  </div>

  <a href="{{ url_for('main.index') }}" class="btn-link">← 대시보드로 돌아가기</a>

  <!-- 유저 선택 -->
  <form method="get" class="mb-3 d-flex gap-2">
    <select class="form-select w-auto" name="user_id" onchange="this.form.submit()">
      {% for u in users %}
        <option value="{{ u.id }}" {% if selected_user and u.id == selected_user.id %}selected{% endif %}>
          {{ u.email or ('User ' ~ u.id) }}
        </option>
      {% endfor %}
    </select>
    <noscript><button class="btn btn-sm btn-success">조회</button></noscript>
  </form>

  <div class="mb-2">
    <small class="text-muted">선택된 유저: <b>{{ selected_user.email if selected_user else '' }}</b> (ID: {{ selected_user.id if selected_user else '' }})</small>
  </div>

  <!-- 요약 카드 -->
  <div class="row g-4 mb-4">
    <div class="col-md-3">
      <div class="card p-3">
        <h5 class="card-title">총 수익</h5>
        <p class="card-text highlight" id="total-profit">
          {{ total_profit if total_profit is defined else 0 }} USDT
        </p>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card p-3">
        <h5 class="card-title">총 거래</h5>
        <p class="card-text highlight" id="total-trades">0 회</p>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card p-3">
        <h5 class="card-title">승률</h5>
        <p class="card-text highlight" id="win-rate">0%</p>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card p-3">
        <h5 class="card-title">평균 수익</h5>
        <p class="card-text highlight" id="avg-profit">0 USDT</p>
      </div>
    </div>
  </div>

  <div class="row">
    <div class="col-md-8">
      <div class="card p-3">
        <h5 class="card-title">📊 일별 손익 그래프</h5>
        <div class="chart-container"><canvas id="pnlChart"></canvas></div>
      </div>
    </div>
    <div class="col-md-4">
      <div class="card p-3">
        <h5 class="card-title">✅ 거래 요약</h5>
        <table class="table table-sm">
          <thead><tr><th>날짜</th><th>손익</th><th>거래수</th></tr></thead>
          <tbody id="summary-table"></tbody>
        </table>
      </div>
    </div>
  </div>

  <script id="admin-pnl-data" type="application/json">{{ data|tojson|safe }}</script>

  <script>
    // 에디터 친화적: 런타임에 JSON만 파싱
    const raw = document.getElementById('admin-pnl-data')?.textContent || '[]';
    let sampleData;
    try { sampleData = JSON.parse(raw) || []; } catch { sampleData = []; }

    const totalProfitRaw = sampleData.reduce((a, b) => a + (b.pnl || 0), 0);
    const totalTrades    = sampleData.reduce((a, b) => a + (b.trades || 0), 0);
    const days           = sampleData.length || 1;
    const winDays        = sampleData.filter(d => (d.pnl || 0) > 0).length;

    const totalProfit = totalProfitRaw.toFixed(2);
    const avgProfit   = (totalProfitRaw / days).toFixed(2);
    const winRate     = ((winDays / days) * 100).toFixed(1);

    document.getElementById('total-profit').innerText = totalProfit + ' USDT';
    document.getElementById('total-trades').innerText = totalTrades + ' 회';
    document.getElementById('win-rate').innerText     = winRate + '%';
    document.getElementById('avg-profit').innerText   = avgProfit + ' USDT';

    const ctx = document.getElementById('pnlChart').getContext('2d');
    new Chart(ctx, {
      type: 'bar',
      data: {
        labels: sampleData.map(d => d.date),
        datasets: [{ label: '손익 (USDT)', data: sampleData.map(d => d.pnl) }]
      },
      options: { scales: { y: { beginAtZero: true } } }
    });

    const tbody = document.getElementById('summary-table');
    sampleData.forEach(row => {
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${row.date}</td><td>${(row.pnl ?? 0).toFixed(2)}</td><td>${row.trades ?? 0}</td>`;
      tbody.appendChild(tr);
    });
  </script>
</body>
</html>
