<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>í†µí•© ê´€ë¦¬ì í˜ì´ì§€</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { background-color: #121212; color: #fff; }
    .container { max-width: 95%; margin-top: 40px; }
    .panel { background-color: #1e1e1e; padding: 20px; border-radius: 8px; }
    table { color: #fff; font-size: 14px; }
    th, td { vertical-align: middle; }
    .form-check-input { margin-top: 6px; }
    .badge-success { background-color: #28a745 !important; }
    .badge-secondary { background-color: #6c757d !important; }
    .btn-sm { margin-bottom: 3px; }
    .proxy-success { color: #28a745; font-weight: bold; }
    .proxy-fail { color: #dc3545; font-weight: bold; }
    .proxy-unknown { color: #ffc107; font-weight: bold; }
  </style>
</head>
<body>
<div class="container">
  <h3 class="mb-4">ğŸ‘‘ Blitz Trade Bot ê´€ë¦¬ì</h3>

  <!-- ìƒë‹¨ ë„¤ë¹„ -->
  <div class="mb-3 d-flex gap-2">
    <a href="/" class="btn btn-sm btn-secondary">â† ëŒ€ì‹œë³´ë“œë¡œ ëŒì•„ê°€ê¸°</a>
    <a href="{{ url_for('main.admin_pnl_summary') }}" class="btn btn-sm btn-outline-info" target="_blank">ê´€ë¦¬ì ì†ìµ ëŒ€ì‹œë³´ë“œ</a>
  </div>

  <div class="panel">
    <h5 class="mb-3">ë“±ë¡ëœ ì‚¬ìš©ì ëª©ë¡</h5>
    <table class="table table-dark table-bordered table-sm">
      <thead>
        <tr>
          <th>Email</th><th>ê±°ë˜ì†Œ</th><th>UID</th><th>í…”ë ˆê·¸ë¨</th><th>API Key</th><th>í”„ë¡ì‹œ</th>
          <th>ì‹¬ë³¼</th><th>ë°©í–¥</th><th>TP</th><th>SL</th><th>ë°˜ë³µ</th>
          <th>ë ˆë²„ë¦¬ì§€</th><th>íšŒì°¨</th><th>ëˆ„ì  PnL</th><th>ìƒíƒœ</th>
          <th>ë ˆí¼ëŸ´ ì˜ˆì™¸</th><th>ì €ì¥/ì œì–´</th>
        </tr>
      </thead>
      <tbody>
        {% for u in users %}
        <tr data-user-id="{{ u.id }}">
          <form method="POST" action="{{ url_for('main.admin_update_user', user_id=u.id) }}">
            <input type="hidden" name="csrf_token" value="{{ csrf_token }}"/>
            <td>
              <a href="{{ url_for('main.admin_user_detail', user_id=u.id) }}">
                {{ u.email }}
              </a>
            </td>
            <td>
              <select name="exchange" class="form-control form-control-sm">
                <option value="bybit" {% if u.exchange == 'bybit' %}selected{% endif %}>Bybit</option>
                <option value="bingx" {% if u.exchange == 'bingx' %}selected{% endif %}>BingX</option>
              </select>
            </td>
            <td><input type="text" name="uid" value="{{ u.uid }}" class="form-control form-control-sm"></td>
            <td>
              <input type="text" name="telegram_token" value="{{ u.telegram_token }}" class="form-control form-control-sm mb-1" placeholder="Token">
              <input type="text" name="telegram_chat_id" value="{{ u.telegram_chat_id }}" class="form-control form-control-sm" placeholder="Chat ID">
            </td>
            <td>
              {% if current_user.email == 'admin@admin.com' %}
              <input type="text" name="api_key" value="{{ u.api_key }}" class="form-control form-control-sm mb-1" placeholder="Key">
              <input type="text" name="api_secret" value="{{ u.api_secret }}" class="form-control form-control-sm" placeholder="Secret">
              {% else %}
                ****<br>****
              {% endif %}
            </td>
            <td>
              {% if proxies.get(u.id) %}
                {{ proxies[u.id].ip }}:{{ proxies[u.id].port }}<br>
                <small>{{ proxies[u.id].username }}</small><br>
              {% else %}
                <span class="text-warning">í• ë‹¹ ì•ˆë¨</span><br>
              {% endif %}
              {% if proxy_statuses.get(u.id) == 'success' %}
                <span class="proxy-success">âœ… ì—°ê²° ì„±ê³µ</span>
              {% elif proxy_statuses.get(u.id) == 'fail' %}
                <span class="proxy-fail">âŒ ì—°ê²° ì‹¤íŒ¨</span>
              {% else %}
                <span class="proxy-unknown">â“ ì•Œ ìˆ˜ ì—†ìŒ</span>
              {% endif %}
            </td>
            <td>
              <select name="symbol" class="form-control form-control-sm">
                {% for s in ['BTC/USDT','ETH/USDT','XRP/USDT'] %}
                  <option value="{{ s }}" {% if u.symbol == s %}selected{% endif %}>{{ s }}</option>
                {% endfor %}
              </select>
            </td>
            <td>
              <select name="side" class="form-control form-control-sm">
                <option value="long" {% if u.side == 'long' %}selected{% endif %}>Long</option>
                <option value="short" {% if u.side == 'short' %}selected{% endif %}>Short</option>
              </select>
            </td>
            <td><input type="text" name="take_profit" value="{{ u.take_profit|replace('%','') }}" class="form-control form-control-sm"></td>
            <td><input type="text" name="stop_loss" value="{{ u.stop_loss|replace('%','') }}" class="form-control form-control-sm"></td>
            <td class="text-center">
              <input type="checkbox" name="repeat" class="form-check-input" {% if u.repeat %}checked{% endif %}>
            </td>
            <td><input type="number" name="leverage" value="{{ u.leverage }}" class="form-control form-control-sm"></td>
            <td><input type="number" name="rounds" value="{{ u.rounds }}" class="form-control form-control-sm"></td>
            <td class="pnl-cell">{{ pnl_by_user.get(u.id, 0) | round(2) }} USDT</td>
            <td class="status-cell">
              <span class="badge {% if user_statuses.get(u.id) == 'ì§„í–‰ ì¤‘' %}badge-success{% else %}badge-secondary{% endif %}">
                {{ user_statuses.get(u.id, 'ì¤‘ì§€ë¨') }}
              </span>
            </td>
            <td class="text-center">
              <input type="checkbox" name="skip_uid_check" class="form-check-input" {% if u.skip_uid_check %}checked{% endif %}>
            </td>
            <td>
              <button type="submit" class="btn btn-success btn-sm">ì €ì¥</button><br>
              <a href="{{ url_for('main.reassign_proxy', user_id=u.id) }}" class="btn btn-warning btn-sm">í”„ë¡ì‹œ ì¬í• ë‹¹</a><br>
              <a href="{{ url_for('main.admin_force_stop', user_id=u.id) }}" class="btn btn-danger btn-sm">ê°•ì œ ì¢…ë£Œ</a><br>
              <a href="{{ url_for('main.admin_force_reset', user_id=u.id) }}" class="btn btn-info btn-sm">ê°•ì œ ë¦¬ì…‹</a><br>

              <!-- ê° ì‚¬ìš©ì ì†ìµ ë³´ê¸° ë²„íŠ¼ -->
              <a href="{{ url_for('main.admin_pnl_summary', user_id=u.id) }}"
                 class="btn btn-outline-success btn-sm" target="_blank">ì†ìµ ë³´ê¸°</a>

              {% if proxies.get(u.id) and u.email != 'admin@admin.com' %}
              <form method="POST" action="{{ url_for('main.unassign_proxy', user_id=u.id) }}" style="margin-top: 4px;" onsubmit="return confirm('ì •ë§ë¡œ í”„ë¡ì‹œë¥¼ í•´ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?');">
                <input type="hidden" name="csrf_token" value="{{ csrf_token }}"/>
                <button type="submit" class="btn btn-outline-light btn-sm">í”„ë¡ì‹œ í•´ì œ</button>
              </form>
              {% elif proxies.get(u.id) and u.email == 'admin@admin.com' %}
                <button class="btn btn-outline-light btn-sm" disabled>í•´ì œ ë¶ˆê°€</button>
              {% endif %}
            </td>
          </form>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>
<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>í†µí•© ê´€ë¦¬ì í˜ì´ì§€</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { background-color: #121212; color: #fff; }
    .container { max-width: 95%; margin-top: 40px; }
    .panel { background-color: #1e1e1e; padding: 20px; border-radius: 8px; }
    table { color: #fff; font-size: 14px; }
    th, td { vertical-align: middle; }
    .form-check-input { margin-top: 6px; }
    .badge-success { background-color: #28a745 !important; }
    .badge-secondary { background-color: #6c757d !important; }
    .btn-sm { margin-bottom: 3px; }
    .proxy-success { color: #28a745; font-weight: bold; }
    .proxy-fail { color: #dc3545; font-weight: bold; }
    .proxy-unknown { color: #ffc107; font-weight: bold; }
  </style>
</head>
<body>
<div class="container">
  <h3 class="mb-4">ğŸ‘‘ Blitz Trade Bot ê´€ë¦¬ì</h3>

  <!-- ìƒë‹¨ ë„¤ë¹„ -->
  <div class="mb-3 d-flex gap-2">
    <a href="/" class="btn btn-sm btn-secondary">â† ëŒ€ì‹œë³´ë“œë¡œ ëŒì•„ê°€ê¸°</a>
    <a href="{{ url_for('main.admin_pnl_summary') }}" class="btn btn-sm btn-outline-info" target="_blank">ê´€ë¦¬ì ì†ìµ ëŒ€ì‹œë³´ë“œ</a>
  </div>

  <div class="panel">
    <h5 class="mb-3">ë“±ë¡ëœ ì‚¬ìš©ì ëª©ë¡</h5>
    <table class="table table-dark table-bordered table-sm">
      <thead>
        <tr>
          <th>Email</th><th>ê±°ë˜ì†Œ</th><th>UID</th><th>í…”ë ˆê·¸ë¨</th><th>API Key</th><th>í”„ë¡ì‹œ</th>
          <th>ì‹¬ë³¼</th><th>ë°©í–¥</th><th>TP</th><th>SL</th><th>ë°˜ë³µ</th>
          <th>ë ˆë²„ë¦¬ì§€</th><th>íšŒì°¨</th><th>ëˆ„ì  PnL</th><th>ìƒíƒœ</th>
          <th>ë ˆí¼ëŸ´ ì˜ˆì™¸</th><th>ì €ì¥/ì œì–´</th>
        </tr>
      </thead>
      <tbody>
        {% for u in users %}
        <tr>
          <form method="POST" action="{{ url_for('main.admin_update_user', user_id=u.id) }}">
            <input type="hidden" name="csrf_token" value="{{ csrf_token }}"/>
            <td>{{ u.email }}</td>
            <td>
              <select name="exchange" class="form-control form-control-sm">
                <option value="bybit" {% if u.exchange == 'bybit' %}selected{% endif %}>Bybit</option>
                <option value="bingx" {% if u.exchange == 'bingx' %}selected{% endif %}>BingX</option>
              </select>
            </td>
            <td><input type="text" name="uid" value="{{ u.uid }}" class="form-control form-control-sm"></td>
            <td>
              <input type="text" name="telegram_token" value="{{ u.telegram_token }}" class="form-control form-control-sm mb-1" placeholder="Token">
              <input type="text" name="telegram_chat_id" value="{{ u.telegram_chat_id }}" class="form-control form-control-sm" placeholder="Chat ID">
            </td>
            <td>
              {% if current_user.email == 'admin@admin.com' %}
              <input type="text" name="api_key" value="{{ u.api_key }}" class="form-control form-control-sm mb-1" placeholder="Key">
              <input type="text" name="api_secret" value="{{ u.api_secret }}" class="form-control form-control-sm" placeholder="Secret">
              {% else %}
                ****<br>****
              {% endif %}
            </td>
            <td>
              {% if proxies.get(u.id) %}
                {{ proxies[u.id].ip }}:{{ proxies[u.id].port }}<br>
                <small>{{ proxies[u.id].username }}</small><br>
              {% else %}
                <span class="text-warning">í• ë‹¹ ì•ˆë¨</span><br>
              {% endif %}
              {% if proxy_statuses.get(u.id) == 'success' %}
                <span class="proxy-success">âœ… ì—°ê²° ì„±ê³µ</span>
              {% elif proxy_statuses.get(u.id) == 'fail' %}
                <span class="proxy-fail">âŒ ì—°ê²° ì‹¤íŒ¨</span>
              {% else %}
                <span class="proxy-unknown">â“ ì•Œ ìˆ˜ ì—†ìŒ</span>
              {% endif %}
            </td>
            <td>
              <select name="symbol" class="form-control form-control-sm">
                {% for s in ['BTC/USDT','ETH/USDT','XRP/USDT'] %}
                  <option value="{{ s }}" {% if u.symbol == s %}selected{% endif %}>{{ s }}</option>
                {% endfor %}
              </select>
            </td>
            <td>
              <select name="side" class="form-control form-control-sm">
                <option value="long" {% if u.side == 'long' %}selected{% endif %}>Long</option>
                <option value="short" {% if u.side == 'short' %}selected{% endif %}>Short</option>
              </select>
            </td>
            <td><input type="text" name="take_profit" value="{{ u.take_profit|replace('%','') }}" class="form-control form-control-sm"></td>
            <td><input type="text" name="stop_loss" value="{{ u.stop_loss|replace('%','') }}" class="form-control form-control-sm"></td>
            <td class="text-center">
              <input type="checkbox" name="repeat" class="form-check-input" {% if u.repeat %}checked{% endif %}>
            </td>
            <td><input type="number" name="leverage" value="{{ u.leverage }}" class="form-control form-control-sm"></td>
            <td><input type="number" name="rounds" value="{{ u.rounds }}" class="form-control form-control-sm"></td>
            <td>{{ pnl_by_user.get(u.id, 0) | round(2) }} USDT</td>
            <td>
              <span class="badge {% if user_statuses.get(u.id) == 'ì§„í–‰ ì¤‘' %}badge-success{% else %}badge-secondary{% endif %}">
                {{ user_statuses.get(u.id, 'ì¤‘ì§€ë¨') }}
              </span>
            </td>
            <td class="text-center">
              <input type="checkbox" name="skip_uid_check" class="form-check-input" {% if u.skip_uid_check %}checked{% endif %}>
            </td>
            <td>
              <button type="submit" class="btn btn-success btn-sm">ì €ì¥</button><br>
              <a href="{{ url_for('main.reassign_proxy', user_id=u.id) }}" class="btn btn-warning btn-sm">í”„ë¡ì‹œ ì¬í• ë‹¹</a><br>
              <a href="{{ url_for('main.admin_force_stop', user_id=u.id) }}" class="btn btn-danger btn-sm">ê°•ì œ ì¢…ë£Œ</a><br>
              <a href="{{ url_for('main.admin_force_reset', user_id=u.id) }}" class="btn btn-info btn-sm">ê°•ì œ ë¦¬ì…‹</a><br>

              <!-- ê° ì‚¬ìš©ì ì†ìµ ë³´ê¸° ë²„íŠ¼ -->
              <a href="{{ url_for('main.admin_pnl_summary', user_id=u.id) }}"
                 class="btn btn-outline-success btn-sm" target="_blank">ì†ìµ ë³´ê¸°</a>

              {% if proxies.get(u.id) and u.email != 'admin@admin.com' %}
              <form method="POST" action="{{ url_for('main.unassign_proxy', user_id=u.id) }}" style="margin-top: 4px;" onsubmit="return confirm('ì •ë§ë¡œ í”„ë¡ì‹œë¥¼ í•´ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?');">
                <input type="hidden" name="csrf_token" value="{{ csrf_token }}"/>
                <button type="submit" class="btn btn-outline-light btn-sm">í”„ë¡ì‹œ í•´ì œ</button>
              </form>
              {% elif proxies.get(u.id) and u.email == 'admin@admin.com' %}
                <button class="btn btn-outline-light btn-sm" disabled>í•´ì œ ë¶ˆê°€</button>
              {% endif %}
            </td>
          </form>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
function refreshUserStatus() {
  $.getJSON('/admin_status_api', function(data) {
    data.users.forEach(function(user) {
      // ìƒíƒœ ê°±ì‹ 
      let statusCell = $('tr[data-user-id="' + user.id + '"] .status-cell');
      if (user.status === 'ì§„í–‰ ì¤‘') {
        statusCell.html('<span class="badge badge-success">ì§„í–‰ ì¤‘</span>');
      } else {
        statusCell.html('<span class="badge badge-secondary">ì¤‘ì§€ë¨</span>');
      }

      // PnL ê°±ì‹ 
      $('tr[data-user-id="' + user.id + '"] .pnl-cell')
        .text(user.pnl.toFixed(2) + ' USDT');
    });
  });
}

// 5ì´ˆë§ˆë‹¤ ìë™ ê°±ì‹ 
setInterval(refreshUserStatus, 5000);
</script>
</body>
</html>

</body>
</html>
