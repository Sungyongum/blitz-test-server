<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="csrf-token" content="{{ csrf_token }}">
    <title>SimpleBotManager - {{ current_user.email }}</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .status-display {
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
            font-family: monospace;
        }
        .btn-group-vertical .btn {
            margin-bottom: 10px;
        }
        .alert {
            margin-top: 15px;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-dark bg-dark">
        <div class="container">
            <span class="navbar-brand">SimpleBotManager</span>
            <div>
                <span class="text-light me-3">{{ current_user.email }}</span>
                <a href="{{ url_for('main.logout') }}" class="btn btn-outline-light btn-sm">Logout</a>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <div class="row">
            <div class="col-md-8">
                <h2>Bot Control Panel</h2>
                
                <!-- Bot Status Display -->
                <div id="status-display" class="status-display bg-light border">
                    <strong>Status:</strong> <span id="bot-status">Loading...</span><br>
                    <strong>Running:</strong> <span id="bot-running">-</span><br>
                    <strong>Uptime:</strong> <span id="bot-uptime">-</span>
                </div>

                <!-- Bot Control Buttons -->
                <div class="btn-group-vertical d-grid gap-2">
                    <button id="start-btn" class="btn btn-success btn-lg" onclick="startBot()">
                        🚀 Start Bot
                    </button>
                    <button id="stop-btn" class="btn btn-danger btn-lg" onclick="stopBot()">
                        🛑 Stop Bot
                    </button>
                    <button id="status-btn" class="btn btn-info btn-lg" onclick="getStatus()">
                        📊 Get Status
                    </button>
                    <button id="recover-btn" class="btn btn-warning btn-lg" onclick="recoverOrders()">
                        🔧 Recover Orders
                    </button>
                </div>

                <!-- Toast container for messages -->
                <div id="message-area"></div>
            </div>
            
            <div class="col-md-4">
                <h4>User Settings</h4>
                <div class="card">
                    <div class="card-body">
                        <p><strong>Exchange:</strong> {{ current_user.exchange or 'bybit' }}</p>
                        <p><strong>Symbol:</strong> {{ current_user.symbol or 'Not set' }}</p>
                        <p><strong>Side:</strong> {{ current_user.side or 'Not set' }}</p>
                        <p><strong>Leverage:</strong> {{ current_user.leverage or 'Not set' }}</p>
                        <hr>
                        <small class="text-muted">
                            Configure these settings via admin panel or direct database access.
                        </small>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // CSRF token handling
        function getCSRFToken() {
            // Extract CSRF token from meta tag if available
            const meta = document.querySelector('meta[name="csrf-token"]');
            return meta ? meta.getAttribute('content') : '';
        }

        // Show toast message
        function showToast(message, type = 'info') {
            const toastHTML = `
                <div class="toast align-items-center text-white bg-${type} border-0 mt-3" role="alert">
                    <div class="d-flex">
                        <div class="toast-body">${message}</div>
                        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
                    </div>
                </div>
            `;
            
            const messageArea = document.getElementById('message-area');
            messageArea.insertAdjacentHTML('beforeend', toastHTML);
            
            const toastElement = messageArea.lastElementChild;
            const toast = new bootstrap.Toast(toastElement);
            toast.show();
            
            // Auto-remove after toast is hidden
            toastElement.addEventListener('hidden.bs.toast', () => {
                toastElement.remove();
            });
        }

        // API call helper
        async function apiCall(endpoint, method = 'GET') {
            try {
                const options = {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json'
                    }
                };
                
                // Add CSRF token for POST requests
                if (method === 'POST') {
                    const csrfToken = getCSRFToken();
                    if (csrfToken) {
                        options.headers['X-CSRFToken'] = csrfToken;
                    }
                }
                
                const response = await fetch(endpoint, options);
                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(data.message || `HTTP ${response.status}`);
                }
                
                return { success: true, data: data };
            } catch (error) {
                return { success: false, error: error.message };
            }
        }

        // Bot control functions
        async function startBot() {
            const btn = document.getElementById('start-btn');
            btn.disabled = true;
            btn.innerHTML = '⏳ Starting...';
            
            const result = await apiCall('/api/bot/start', 'POST');
            
            if (result.success) {
                showToast(result.data.message, 'success');
                getStatus(); // Refresh status
            } else {
                showToast(`Failed to start bot: ${result.error}`, 'danger');
            }
            
            btn.disabled = false;
            btn.innerHTML = '🚀 Start Bot';
        }

        async function stopBot() {
            const btn = document.getElementById('stop-btn');
            btn.disabled = true;
            btn.innerHTML = '⏳ Stopping...';
            
            const result = await apiCall('/api/bot/stop', 'POST');
            
            if (result.success) {
                showToast(result.data.message, 'success');
                getStatus(); // Refresh status
            } else {
                showToast(`Failed to stop bot: ${result.error}`, 'danger');
            }
            
            btn.disabled = false;
            btn.innerHTML = '🛑 Stop Bot';
        }

        async function getStatus() {
            const btn = document.getElementById('status-btn');
            btn.disabled = true;
            btn.innerHTML = '⏳ Checking...';
            
            const result = await apiCall('/api/bot/status', 'GET');
            
            if (result.success) {
                const status = result.data;
                document.getElementById('bot-status').textContent = status.status;
                document.getElementById('bot-running').textContent = status.running ? 'Yes' : 'No';
                document.getElementById('bot-uptime').textContent = status.uptime > 0 ? `${status.uptime}s` : 'N/A';
                
                // Update status display color
                const statusDisplay = document.getElementById('status-display');
                statusDisplay.className = 'status-display border ' + 
                    (status.running ? 'bg-light-green border-success' : 'bg-light border-secondary');
                
                showToast(status.message, status.running ? 'success' : 'info');
            } else {
                showToast(`Failed to get status: ${result.error}`, 'danger');
            }
            
            btn.disabled = false;
            btn.innerHTML = '📊 Get Status';
        }

        async function recoverOrders() {
            const btn = document.getElementById('recover-btn');
            btn.disabled = true;
            btn.innerHTML = '⏳ Recovering...';
            
            const result = await apiCall('/api/bot/recover', 'POST');
            
            if (result.success) {
                const actions = result.data.actions || [];
                const actionText = actions.length > 0 ? ` (${actions.join(', ')})` : '';
                showToast(result.data.message + actionText, 'success');
            } else {
                showToast(`Failed to recover orders: ${result.error}`, 'danger');
            }
            
            btn.disabled = false;
            btn.innerHTML = '🔧 Recover Orders';
        }

        // Auto-refresh status every 30 seconds
        setInterval(getStatus, 30000);
        
        // Initial status check
        document.addEventListener('DOMContentLoaded', function() {
            getStatus();
        });
    </script>
</body>
</html>