<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PnL 대시보드 - Blitz Bot</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --bg-primary: #0a0a0a;
            --bg-secondary: #1a1a1a;
            --bg-panel: #222;
            --border-color: #333;
            --text-primary: #e0e0e0;
            --text-secondary: #b0b0b0;
            --accent-primary: #4dabf7;
            --accent-success: #51cf66;
            --accent-warning: #ffd43b;
            --accent-danger: #ff6b6b;
        }
        
        body { 
            background: linear-gradient(135deg, var(--bg-primary) 0%, #1a1a2e 100%);
            color: var(--text-primary);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            min-height: 100vh;
        }
        
        .container { max-width: 95%; margin-top: 20px; }
        
        .panel { 
            background: var(--bg-panel);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 24px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.3);
        }
        
        .metric-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            height: 100%;
        }
        
        .metric-value {
            font-size: 2rem;
            font-weight: bold;
            margin-bottom: 8px;
        }
        
        .metric-label {
            color: var(--text-secondary);
            font-size: 0.9rem;
        }
        
        .metric-change {
            font-size: 0.8rem;
            margin-top: 8px;
        }
        
        .chart-container {
            position: relative;
            height: 300px;
            margin: 20px 0;
        }
        
        .win-rate-gauge {
            width: 200px;
            height: 200px;
            margin: 0 auto;
        }
        
        .table-dark {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
        }
        
        .table-dark th {
            background: var(--bg-primary);
            border-color: var(--border-color);
            color: var(--accent-primary);
        }
        
        .table-dark td {
            border-color: var(--border-color);
        }
        
        .btn {
            border-radius: 6px;
            font-weight: 500;
            transition: all 0.2s ease;
        }
        
        .user-selector {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
<div class="container">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2><i class="bi bi-graph-up"></i> PnL 대시보드</h2>
        <div class="d-flex gap-2">
            <a href="/admin_enhanced" class="btn btn-outline-light btn-sm">
                <i class="bi bi-arrow-left"></i> 관리자 페이지
            </a>
            <a href="/" class="btn btn-outline-light btn-sm">
                <i class="bi bi-house"></i> 대시보드
            </a>
        </div>
    </div>

    <!-- User Selector -->
    <div class="user-selector">
        <div class="row align-items-center">
            <div class="col-md-4">
                <label for="userSelect" class="form-label">사용자 선택:</label>
                <select class="form-select" id="userSelect" onchange="loadUserData()">
                    <option value="">전체 사용자</option>
                </select>
            </div>
            <div class="col-md-4">
                <label for="periodSelect" class="form-label">기간:</label>
                <select class="form-select" id="periodSelect" onchange="updatePeriod()">
                    <option value="7">최근 7일</option>
                    <option value="30" selected>최근 30일</option>
                    <option value="90">최근 90일</option>
                    <option value="all">전체 기간</option>
                </select>
            </div>
            <div class="col-md-4">
                <label class="form-label">&nbsp;</label>
                <button class="btn btn-primary w-100" onclick="refreshData()">
                    <i class="bi bi-arrow-clockwise"></i> 새로고침
                </button>
            </div>
        </div>
    </div>

    <!-- Metrics Overview -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="metric-card">
                <div class="metric-value text-primary" id="totalPnL">0.00</div>
                <div class="metric-label">총 PnL (USDT)</div>
                <div class="metric-change text-muted" id="pnlChange">-</div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="metric-card">
                <div class="metric-value text-info" id="totalTrades">0</div>
                <div class="metric-label">총 거래 수</div>
                <div class="metric-change text-muted" id="tradesChange">-</div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="metric-card">
                <div class="metric-value text-success" id="winRate">0.0%</div>
                <div class="metric-label">승률</div>
                <div class="metric-change" id="winRateBreakdown">0승 0패</div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="metric-card">
                <div class="metric-value text-warning" id="avgPnL">0.00</div>
                <div class="metric-label">평균 PnL</div>
                <div class="metric-change text-muted" id="avgPnLChange">-</div>
            </div>
        </div>
    </div>

    <!-- Charts Row -->
    <div class="row">
        <div class="col-md-8">
            <div class="panel">
                <h5><i class="bi bi-bar-chart"></i> 일별 PnL 추이</h5>
                <div class="chart-container">
                    <canvas id="pnlChart"></canvas>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="panel">
                <h5><i class="bi bi-pie-chart"></i> 승부 분석</h5>
                <div class="chart-container">
                    <canvas id="winLossChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Performance Table -->
    <div class="panel">
        <h5><i class="bi bi-table"></i> 일별 상세 내역</h5>
        <div class="table-responsive">
            <table class="table table-dark table-hover">
                <thead>
                    <tr>
                        <th>날짜</th>
                        <th>PnL (USDT)</th>
                        <th>거래 수</th>
                        <th>승</th>
                        <th>패</th>
                        <th>승률</th>
                        <th>평균 PnL</th>
                    </tr>
                </thead>
                <tbody id="dailyTableBody">
                    <tr>
                        <td colspan="7" class="text-center text-muted">데이터를 불러오는 중...</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
let currentUserData = null;
let pnlChart = null;
let winLossChart = null;

// Initialize page
document.addEventListener('DOMContentLoaded', function() {
    loadUsers();
    loadUserData();
});

async function loadUsers() {
    try {
        const response = await fetch('/api/admin/users');
        if (response.ok) {
            const data = await response.json();
            const select = document.getElementById('userSelect');
            
            // Clear existing options except "전체 사용자"
            select.innerHTML = '<option value="">전체 사용자</option>';
            
            data.users.forEach(user => {
                const option = document.createElement('option');
                option.value = user.id;
                option.textContent = `${user.email} (ID: ${user.id})`;
                select.appendChild(option);
            });
        }
    } catch (error) {
        console.error('Failed to load users:', error);
    }
}

async function loadUserData() {
    const userId = document.getElementById('userSelect').value;
    const period = document.getElementById('periodSelect').value;
    
    try {
        let url;
        if (userId) {
            url = `/api/users/${userId}/pnl/summary`;
        } else {
            url = '/api/admin/pnl/all_users';
        }
        
        const response = await fetch(url);
        if (response.ok) {
            const data = await response.json();
            
            if (userId) {
                // Single user data
                currentUserData = data;
                updateMetrics(data);
                updateCharts(data.daily_data || []);
                updateTable(data.daily_data || []);
            } else {
                // All users aggregated data
                const aggregated = aggregateAllUsersData(data.users);
                currentUserData = aggregated;
                updateMetrics(aggregated);
                updateCharts(aggregated.daily_data || []);
                updateTable(aggregated.daily_data || []);
            }
        }
    } catch (error) {
        console.error('Failed to load user data:', error);
    }
}

function aggregateAllUsersData(users) {
    // Aggregate data from all users
    let totalPnL = 0;
    let totalWins = 0;
    let totalLosses = 0;
    const dailyMap = new Map();
    
    users.forEach(user => {
        if (user.error) return;
        
        totalPnL += user.total_pnl || 0;
        totalWins += user.total_wins || 0;
        totalLosses += user.total_losses || 0;
        
        // Aggregate daily data (would need to fetch individual daily data for accuracy)
        if (user.daily_data) {
            user.daily_data.forEach(day => {
                const date = day.date;
                if (!dailyMap.has(date)) {
                    dailyMap.set(date, {
                        date: date,
                        gross_pnl: 0,
                        wins: 0,
                        losses: 0,
                        trades: 0
                    });
                }
                const existing = dailyMap.get(date);
                existing.gross_pnl += day.gross_pnl || 0;
                existing.wins += day.wins || 0;
                existing.losses += day.losses || 0;
                existing.trades += day.trades || 0;
            });
        }
    });
    
    const dailyData = Array.from(dailyMap.values()).sort((a, b) => b.date.localeCompare(a.date));
    
    return {
        total_pnl: totalPnL,
        total_wins: totalWins,
        total_losses: totalLosses,
        total_trades: totalWins + totalLosses,
        overall_win_rate: totalWins + totalLosses > 0 ? (totalWins / (totalWins + totalLosses) * 100) : 0,
        daily_data: dailyData
    };
}

function updateMetrics(data) {
    document.getElementById('totalPnL').textContent = (data.total_pnl || 0).toFixed(2);
    document.getElementById('totalTrades').textContent = data.total_trades || 0;
    document.getElementById('winRate').textContent = (data.overall_win_rate || 0).toFixed(1) + '%';
    
    const avgPnL = data.total_trades > 0 ? (data.total_pnl / data.total_trades) : 0;
    document.getElementById('avgPnL').textContent = avgPnL.toFixed(2);
    
    document.getElementById('winRateBreakdown').textContent = 
        `${data.total_wins || 0}승 ${data.total_losses || 0}패`;
    
    // Update metric colors
    const pnlElement = document.getElementById('totalPnL');
    pnlElement.className = 'metric-value ' + (data.total_pnl >= 0 ? 'text-success' : 'text-danger');
}

function updateCharts(dailyData) {
    updatePnLChart(dailyData);
    updateWinLossChart(dailyData);
}

function updatePnLChart(dailyData) {
    const ctx = document.getElementById('pnlChart').getContext('2d');
    
    if (pnlChart) {
        pnlChart.destroy();
    }
    
    const period = document.getElementById('periodSelect').value;
    let filteredData = dailyData;
    
    if (period !== 'all') {
        const daysToShow = parseInt(period);
        filteredData = dailyData.slice(0, daysToShow);
    }
    
    filteredData = filteredData.reverse(); // Show chronologically
    
    pnlChart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: filteredData.map(d => d.date),
            datasets: [{
                label: 'Daily PnL',
                data: filteredData.map(d => d.gross_pnl),
                backgroundColor: filteredData.map(d => d.gross_pnl >= 0 ? 'rgba(81, 207, 102, 0.8)' : 'rgba(255, 107, 107, 0.8)'),
                borderColor: filteredData.map(d => d.gross_pnl >= 0 ? 'rgba(81, 207, 102, 1)' : 'rgba(255, 107, 107, 1)'),
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    labels: {
                        color: '#e0e0e0'
                    }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    grid: {
                        color: '#333'
                    },
                    ticks: {
                        color: '#b0b0b0'
                    }
                },
                x: {
                    grid: {
                        color: '#333'
                    },
                    ticks: {
                        color: '#b0b0b0'
                    }
                }
            }
        }
    });
}

function updateWinLossChart(dailyData) {
    const ctx = document.getElementById('winLossChart').getContext('2d');
    
    if (winLossChart) {
        winLossChart.destroy();
    }
    
    const totalWins = dailyData.reduce((sum, d) => sum + (d.wins || 0), 0);
    const totalLosses = dailyData.reduce((sum, d) => sum + (d.losses || 0), 0);
    
    winLossChart = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: ['승', '패'],
            datasets: [{
                data: [totalWins, totalLosses],
                backgroundColor: ['rgba(81, 207, 102, 0.8)', 'rgba(255, 107, 107, 0.8)'],
                borderColor: ['rgba(81, 207, 102, 1)', 'rgba(255, 107, 107, 1)'],
                borderWidth: 2
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom',
                    labels: {
                        color: '#e0e0e0'
                    }
                }
            }
        }
    });
}

function updateTable(dailyData) {
    const tbody = document.getElementById('dailyTableBody');
    tbody.innerHTML = '';
    
    if (dailyData.length === 0) {
        tbody.innerHTML = '<tr><td colspan="7" class="text-center text-muted">데이터가 없습니다.</td></tr>';
        return;
    }
    
    dailyData.forEach(day => {
        const row = document.createElement('tr');
        const winRate = day.wins + day.losses > 0 ? (day.wins / (day.wins + day.losses) * 100) : 0;
        const avgPnL = day.trades > 0 ? (day.gross_pnl / day.trades) : 0;
        const pnlClass = day.gross_pnl >= 0 ? 'text-success' : 'text-danger';
        
        row.innerHTML = `
            <td>${day.date}</td>
            <td class="${pnlClass}">${day.gross_pnl.toFixed(2)}</td>
            <td>${day.trades}</td>
            <td class="text-success">${day.wins}</td>
            <td class="text-danger">${day.losses}</td>
            <td>${winRate.toFixed(1)}%</td>
            <td class="${avgPnL >= 0 ? 'text-success' : 'text-danger'}">${avgPnL.toFixed(2)}</td>
        `;
        tbody.appendChild(row);
    });
}

function updatePeriod() {
    if (currentUserData) {
        updateCharts(currentUserData.daily_data || []);
    }
}

function refreshData() {
    loadUserData();
}
</script>
</body>
</html>