{% extends "base.html" %}

{% block title %}Blitz LITE Admin Console{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-12">
        <h2>üõ†Ô∏è Blitz LITE Admin Console</h2>
        <p class="text-muted">Monitor and control user bots</p>
        
        <div class="card mb-4">
            <div class="card-header">
                <h5>üìä System Overview</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-3">
                        <div class="card bg-primary text-white">
                            <div class="card-body">
                                <h4 id="total-users">-</h4>
                                <small>Total Users</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card bg-success text-white">
                            <div class="card-body">
                                <h4 id="running-bots">-</h4>
                                <small>Running Bots</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card bg-warning text-white">
                            <div class="card-body">
                                <h4 id="stopped-bots">-</h4>
                                <small>Stopped Bots</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card bg-info text-white">
                            <div class="card-body">
                                <small id="last-update">Never</small>
                                <br><small>Last Update</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="card">
            <div class="card-header d-flex justify-content-between">
                <h5>üë• User Bot Management</h5>
                <div>
                    <button id="btn-refresh" class="btn btn-sm btn-outline-primary">üîÑ Refresh</button>
                    <div class="form-check form-check-inline">
                        <input class="form-check-input" type="checkbox" id="auto-refresh" checked>
                        <label class="form-check-label" for="auto-refresh">Auto-refresh (10s)</label>
                    </div>
                </div>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>User ID</th>
                                <th>Status</th>
                                <th>Uptime</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="users-table">
                            <tr>
                                <td colspan="4" class="text-center text-muted">
                                    Loading users...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        
        <div id="alerts" class="mt-3"></div>
    </div>
</div>

<script>
let autoRefreshInterval = null;

function showAlert(message, type = 'info') {
    const alertsDiv = document.getElementById('alerts');
    const alertHTML = `
        <div class="alert alert-${type} alert-dismissible fade show" role="alert">
            ${message}
            <button type="button" class="close" data-dismiss="alert">
                <span>&times;</span>
            </button>
        </div>
    `;
    alertsDiv.innerHTML = alertHTML;
    
    // Auto-hide after 5 seconds
    setTimeout(() => {
        const alert = alertsDiv.querySelector('.alert');
        if (alert) alert.remove();
    }, 5000);
}

async function callAPI(endpoint, method = 'GET') {
    try {
        const response = await fetch(endpoint, {
            method: method,
            headers: {
                'Content-Type': 'application/json',
            },
            credentials: 'same-origin'
        });
        
        const data = await response.json();
        return { data, status: response.status };
        
    } catch (error) {
        return { error: error.message, status: 500 };
    }
}

async function callUserAPI(userId, action) {
    const endpoint = `/api/bot/${action}`;
    const method = action === 'status' ? 'GET' : 'POST';
    
    // For admin actions on other users, we'd need different endpoints
    // For now, this is a placeholder for the user's own actions
    return await callAPI(endpoint, method);
}

function formatUptime(seconds) {
    if (!seconds || seconds === 0) return 'N/A';
    
    const minutes = Math.floor(seconds / 60);
    const hours = Math.floor(minutes / 60);
    const days = Math.floor(hours / 24);
    
    if (days > 0) return `${days}d ${hours % 24}h`;
    if (hours > 0) return `${hours}h ${minutes % 60}m`;
    return `${minutes}m`;
}

function updateUsersTable(data) {
    const tbody = document.getElementById('users-table');
    
    if (data.error) {
        tbody.innerHTML = `
            <tr>
                <td colspan="4" class="text-center text-danger">
                    Error: ${data.error}
                </td>
            </tr>
        `;
        return;
    }
    
    const users = data.users || {};
    const userIds = Object.keys(users);
    
    if (userIds.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="4" class="text-center text-muted">
                    No users found
                </td>
            </tr>
        `;
        return;
    }
    
    tbody.innerHTML = userIds.map(userId => {
        const user = users[userId];
        const running = user.running;
        const statusBadge = running ? 
            '<span class="badge badge-success">üü¢ Running</span>' : 
            '<span class="badge badge-secondary">üî¥ Stopped</span>';
        const uptime = formatUptime(user.uptime);
        
        return `
            <tr>
                <td>${userId}</td>
                <td>${statusBadge}</td>
                <td>${uptime}</td>
                <td>
                    <div class="btn-group btn-group-sm">
                        <button class="btn btn-outline-success" onclick="forceAction(${userId}, 'start')" ${running ? 'disabled' : ''}>
                            Start
                        </button>
                        <button class="btn btn-outline-danger" onclick="forceAction(${userId}, 'stop')" ${!running ? 'disabled' : ''}>
                            Stop
                        </button>
                        <button class="btn btn-outline-warning" onclick="forceAction(${userId}, 'recover')">
                            Recover
                        </button>
                    </div>
                </td>
            </tr>
        `;
    }).join('');
}

function updateOverview(data) {
    if (data.error) return;
    
    const totalUsers = data.total_users || 0;
    const runningBots = data.total_running || 0;
    const stoppedBots = totalUsers - runningBots;
    
    document.getElementById('total-users').textContent = totalUsers;
    document.getElementById('running-bots').textContent = runningBots;
    document.getElementById('stopped-bots').textContent = stoppedBots;
    document.getElementById('last-update').textContent = new Date().toLocaleTimeString();
}

async function refreshData() {
    const result = await callAPI('/admin/simple/status', 'GET');
    
    if (result.data) {
        updateOverview(result.data);
        updateUsersTable(result.data);
    } else {
        showAlert(`‚ùå Failed to refresh data: ${result.error}`, 'danger');
    }
}

async function forceAction(userId, action) {
    // Note: This is a placeholder. In a real implementation, you'd need
    // admin-specific endpoints that can control other users' bots
    showAlert(`Admin action '${action}' for user ${userId} would be implemented here`, 'info');
    
    // For now, just refresh the data
    setTimeout(() => refreshData(), 1000);
}

// Setup auto-refresh
function setupAutoRefresh() {
    const checkbox = document.getElementById('auto-refresh');
    
    function toggleAutoRefresh() {
        if (checkbox.checked) {
            autoRefreshInterval = setInterval(refreshData, 10000); // 10 seconds
        } else {
            if (autoRefreshInterval) {
                clearInterval(autoRefreshInterval);
                autoRefreshInterval = null;
            }
        }
    }
    
    checkbox.addEventListener('change', toggleAutoRefresh);
    toggleAutoRefresh(); // Initial setup
}

// Event handlers
document.getElementById('btn-refresh').addEventListener('click', refreshData);

// Initialize page
document.addEventListener('DOMContentLoaded', () => {
    setupAutoRefresh();
    refreshData();
});

// Cleanup on page unload
window.addEventListener('beforeunload', () => {
    if (autoRefreshInterval) {
        clearInterval(autoRefreshInterval);
    }
});
</script>
{% endblock %}