<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"/>
  <script src="https://unpkg.com/lightweight-charts/dist/lightweight-charts.umd.js"></script>
  <title>ğŸš€ Blitz Trade Bot Dashboard</title>
  <!-- Bootstrap 4 -->
  <link
    rel="stylesheet"
    href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css"
  />
  <style>
    body { background: #121212; color: #f1f1f1; }
    .panel { background: #1e1e1e; padding: 1.5rem; border-radius: .5rem; margin-bottom: 1rem; }
    .nav-tabs .nav-link { color: #f1f1f1; }
    .nav-tabs .nav-link.active { background: #2a2a2a; }
    .table-dark th, .table-dark td { color: #f1f1f1; }
    pre { background: #111; color: #f1f1f1; }
    label { font-weight: 500; font-size: .9rem; }
    #tv_chart { width: 100%; height: 50vh; }
    .btn-block + .btn-block { margin-top: .5rem; }
    hr { border-color: #333; }
  </style>
</head>
<body>
  <!-- ë¶€íŠ¸ìŠ¤íŠ¸ë© í† ìŠ¤íŠ¸ ì•Œë¦¼ -->
  <div aria-live="polite" aria-atomic="true"
      style="position: fixed; bottom: 1rem; right: 1rem; z-index: 1080; pointer-events: none;">
    <div id="toast-container">
      {% with messages = get_flashed_messages(with_categories=true) %}
        {% for category, message in messages %}
        <div class="toast show" role="alert" aria-live="assertive" aria-atomic="true"
            data-delay="3000" style="pointer-events: auto;">
          <div class="toast-header">
            <strong class="mr-auto">
              {% if category == 'success' %}âœ… ì„±ê³µ
              {% elif category == 'danger' %}âŒ ì˜¤ë¥˜
              {% elif category == 'warning' %}âš ï¸ ê²½ê³ 
              {% else %}â„¹ï¸ ì•Œë¦¼
              {% endif %}
            </strong>
            <small>ì§€ê¸ˆ</small>
            <button type="button" class="ml-2 mb-1 close" data-dismiss="toast" aria-label="Close">
              <span aria-hidden="true">&times;</span>
            </button>
          </div>
          <div class="toast-body">
            {{ message }}
          </div>
        </div>
        {% endfor %}
      {% endwith %}
    </div>
  </div>

  <div class="container-fluid py-4">

    <!-- ìƒë‹¨ í—¤ë” -->
    <div class="d-flex justify-content-between align-items-center mb-4">
      <div class="d-flex align-items-center">
        <img src="{{ url_for('static', filename='Logo.png') }}" alt="Logo" style="height:32px; margin-right:12px;">
        <h3>Blitz Trade Bot Dashboard</h3>
      </div>
      <div>
        <span>ìƒíƒœ:
          <span id="status-badge" class="badge badge-info">{{ status_text or 'ëŒ€ê¸°ì¤‘' }}</span>
        </span>
        <a href="{{ url_for('main.pnl_summary') }}" class="btn btn-info btn-sm mt-2">ğŸ“Š ì†ìµ í˜„í™© ë³´ê¸°</a>
        <a href="{{ url_for('main.edit_profile') }}" class="btn btn-outline-light btn-sm ml-2">íšŒì›ì •ë³´ ìˆ˜ì •</a>
        <a href="{{ url_for('main.logout') }}" class="btn btn-outline-light btn-sm ml-3">ë¡œê·¸ì•„ì›ƒ</a>
        {% if current_user.email=='admin@admin.com' %}
          <a href="{{ url_for('main.admin_page') }}" class="btn btn-outline-warning btn-sm ml-2">ê´€ë¦¬ì</a>
        {% endif %}
      </div>
    </div>

    <!-- ì„¤ì • í¼ ìë™ ë¡œë“œ ìŠ¤í¬ë¦½íŠ¸ (ê¸°ì¡´ ìŠ¤ë‹ˆí« ìœ ì§€) -->
    <script>
      document.addEventListener('DOMContentLoaded', () => {
        renderGrids();
        const roundsEl = document.getElementById('roundsInput');
        if (roundsEl) roundsEl.addEventListener('input', renderGrids);
      });
      // (ê¸°ì¡´ ì‹¬ë³¼ ê²€ìƒ‰/ì„ íƒ ê´€ë ¨ í•¸ë“¤ëŸ¬ëŠ” ì‹¤ì œ ìš”ì†Œë“¤ì´ ë³„ë„ í…œí”Œë¦¿ì— ìˆì—ˆë‹¤ë©´ ê·¸ëŒ€ë¡œ ìœ ì§€)
    </script>

    <!-- 1) ì„¤ì • í¼ + ì°¨íŠ¸ -->
    <div class="row">
      <!-- ì™¼ìª½: ì„¤ì • í¼ -->
      <div class="col-lg-4">
        <div class="panel">
          <h5 class="mb-3">ğŸ’¾ ì„¤ì •</h5>

          <!-- ğŸ”§ AJAXë¡œ ì§ë ¬í™”í•´ì„œ ì“°ê¸° ìœ„í•´ id ë¶€ì—¬ -->
          <form id="settings-form" action="{{ url_for('main.index') }}" method="post">
            <input type="hidden" name="csrf_token" value="{{ csrf_token }}"/>
            <h6>í™˜ì˜í•©ë‹ˆë‹¤, {{ current_user.email }} ë‹˜</h6>
            <p class="mb-2"><b>ê±°ë˜ì†Œ:</b>
              <span class="badge badge-warning">
                {% if current_user.exchange == 'bybit' %}Bybit
                {% elif current_user.exchange == 'bingx' %}BingX
                {% else %}{{ current_user.exchange|capitalize }}
                {% endif %}
              </span>
            </p>
            <div class="form-row">
              <div class="form-group">
                <label for="symbolSelect">ì‹¬ë³¼</label>
                <select name="symbol" class="form-control" style="min-width:150px;">
                  {% for item in symbols %}
                    <option value="{{ item.symbol }}" {% if current_user.symbol == item.symbol %}selected{% endif %}>
                      {{ item.symbol }} ({{ item.price }})
                    </option>
                  {% endfor %}
                </select>
              </div>
              <div class="form-group col">
                <label>ë°©í–¥</label>
                <select name="side" class="form-control form-control-sm">
                  <option value="long" {% if current_user.side=='long' %}selected{% endif %}>Long</option>
                  <option value="short" {% if current_user.side=='short' %}selected{% endif %}>Short</option>
                </select>
              </div>
            </div>
            <hr>
            <div class="form-group">
              <label>ë ˆë²„ë¦¬ì§€</label>
              <select name="leverage" class="form-control form-control-sm">
                {% for lv in [1,2,3,5,10,15,20,25,50] %}
                  <option value="{{ lv }}" {% if current_user.leverage==lv %}selected{% endif %}>{{ lv }}ë°°</option>
                {% endfor %}
              </select>
            </div>
            <div class="form-group">
              <label>ìµì ˆ (%)</label>
              <input type="number" name="take_profit" class="form-control form-control-sm"
                     step="0.1" min="0.1"
                     value="{{ current_user.take_profit|replace('%','') }}" required>
            </div>
            <div class="form-group form-check">
              <input type="checkbox" class="form-check-input" id="repeatCheck" name="repeat"
                     {% if current_user.repeat %}checked{% endif %}>
              <label class="form-check-label" for="repeatCheck">ë°˜ë³µ ì‹¤í–‰</label>
            </div>
            <div class="form-group">
              <label for="roundsInput">ê·¸ë¦¬ë“œ íšŒì°¨ ìˆ˜</label>
              <input type="number" id="roundsInput" name="rounds" class="form-control form-control-sm"
                     value="{{ current_user.rounds }}" min="1">
            </div>
            <div id="gridContainer" data-initial-grids='{{ current_user.grids|default([])|tojson|safe }}'></div>
            <div class="mt-2 font-weight-bold">ì´ í•©ê³„: <span id="sumValue">0.00</span> USDT</div>

            <!-- ğŸ”˜ ë²„íŠ¼ë“¤ì— id ë¶€ì—¬ (AJAXìš©) -->
            <button id="save-btn" type="submit" class="btn btn-primary btn-block btn-sm">ì €ì¥</button>
            <button id="start-btn" type="button" class="btn btn-success btn-block btn-sm">ì‹œì‘</button>
            <button id="stop-grid-btn" type="button" class="btn btn-warning btn-block btn-sm">ê·¸ë¦¬ë“œë§Œ ì¤‘ë‹¨</button>
            <button id="stop-repeat-btn" type="button" class="btn btn-warning btn-block btn-sm">ë°˜ë³µ ì •ì§€</button>
            <button id="exit-stop-btn" type="button" class="btn btn-danger btn-block btn-sm">í¬ì§€ì…˜ ì²­ì‚° í›„ ì •ì§€</button>
          </form>

          <!-- ê°•ì œ ê°±ì‹  (ë³„ë„ í¼ì´ì—ˆìœ¼ë‚˜ AJAXë¡œ ì „í™˜) -->
          <div class="mt-2">
            <button id="force-on-btn"  class="btn btn-info btn-block btn-sm">ğŸ”„ ì—°ì† ê°•ì œ ê°±ì‹ </button>
            <button id="force-off-btn" class="btn btn-secondary btn-block btn-sm">â¹ï¸ ê°•ì œ ê°±ì‹  í•´ì œ</button>
            <button id="force-once-btn" class="btn btn-warning btn-block btn-sm">ğŸ” í•œ ë²ˆë§Œ ê°±ì‹ </button>
          </div>
        </div>
      </div>

      <div class="col-lg-8">
        <div class="panel">
          <h5>ğŸ“Š ì‹¤ì‹œê°„ ì°¨íŠ¸</h5>
          <div id="tradingview_chart" style="height: 800px;"></div>
        </div>
      </div>
    </div>

    <!-- TradingView Widget Script -->
    <script type="text/javascript" src="https://s3.tradingview.com/tv.js"></script>
    <script type="text/javascript">
      new TradingView.widget({
        "container_id": "tradingview_chart",
        "autosize": true,
        "symbol": "{{ current_user.symbol.replace('/', '').replace(':USDT', '') }}",
        "interval": "15",
        "timezone": "Etc/UTC",
        "theme": "dark",
        "style": "1",
        "locale": "kr",
        "toolbar_bg": "#1e1e1e",
        "enable_publishing": false,
        "hide_top_toolbar": false,
        "hide_legend": false,
        "save_image": false,
        "studies": [],
        "show_popup_button": false,
        "withdateranges": true,
        "details": false,
        "calendar": false
      });
    </script>

    <!-- ì´í•˜ ì›ë˜ì˜ ìì‚°/í¬ì§€ì…˜/ë‚´ì—­/ë¡œê·¸ ì„¹ì…˜ ê·¸ëŒ€ë¡œ ìœ ì§€ -->
    <div class="row mt-4">
      <div class="col-12">
        <div class="panel">
          <h5>ğŸ’° ì´ ìì‚°</h5>
          <p>ì´ ìì‚°: {{ "{:.2f}".format(total_equity or 0) }} USDTâ€‚â€‚ì‚¬ìš© ê°€ëŠ¥: {{ "{:.2f}".format(free_usdt or 0) }} USDT</p>
        </div>

        <ul class="nav nav-tabs" id="dashboardTabs" role="tablist">
          <li class="nav-item"><a class="nav-link active" data-toggle="tab" href="#pane-position">í¬ì§€ì…˜</a></li>
          <li class="nav-item"><a class="nav-link" data-toggle="tab" href="#pane-orders">ë¯¸ì²´ê²° ì£¼ë¬¸</a></li>
          <li class="nav-item"><a class="nav-link" data-toggle="tab" href="#pane-history">ì²´ê²° ë‚´ì—­</a></li>
          <li class="nav-item"><a class="nav-link" data-toggle="tab" href="#pane-bots">ë™ì‘ì¤‘ì¸ ë´‡</a></li>
          <li class="nav-item"><a class="nav-link" data-toggle="tab" href="#pane-saved">ì„ì‹œì €ì¥ ì¢…ëª©</a></li>
        </ul>

        <div class="tab-content mt-3">
          <div id="pane-position" class="tab-pane fade show active">
            <div class="panel">
              <h5>ğŸ“Œ í˜„ì¬ ì§„í–‰ ì¤‘ í¬ì§€ì…˜</h5>
              {% if current_position %}
              <table class="table table-sm table-dark">
                <thead>
                  <tr>
                    <th>ì‹¬ë³¼</th><th>ë°©í–¥</th><th>ì§„ì…ê°€</th><th>ìˆ˜ëŸ‰</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td>{{ current_position.symbol }}</td>
                    <td>{{ current_position.side }}</td>
                    <td>{{ current_position.entryPrice }}</td>
                    <td>{{ current_position.contracts }}</td>
                  </tr>
                </tbody>
              </table>
              {% else %}
              <p class="text-muted">ì§„í–‰ ì¤‘ì¸ í¬ì§€ì…˜ì´ ì—†ìŠµë‹ˆë‹¤.</p>
              {% endif %}
            </div>
          </div>

          <div id="pane-orders" class="tab-pane fade">
            <div class="panel">
              <h5>ğŸ“ ë¯¸ì²´ê²° ì£¼ë¬¸</h5>
              {% if open_orders %}
              <table class="table table-sm table-dark">
                <thead>
                  <tr>
                    <th>ì£¼ë¬¸ ID</th><th>íƒ€ì…</th><th>ê°€ê²©</th><th>ìˆ˜ëŸ‰</th>
                  </tr>
                </thead>
                <tbody>
                  {% for o in open_orders %}
                  <tr>
                    <td>{{ o.id }}</td>
                    <td>{{ o.side }} {{ o.type }} <small>{{ o.info.text }}</small></td>
                    <td>{{ o.price }}</td>
                    <td>{{ o.amount }}</td>
                  </tr>
                  {% endfor %}
                </tbody>
              </table>
              {% else %}
              <p class="text-muted">ë¯¸ì²´ê²° ì£¼ë¬¸ì´ ì—†ìŠµë‹ˆë‹¤.</p>
              {% endif %}
            </div>
          </div>

          <div id="pane-history" class="tab-pane fade">
            <div class="panel">
              <h5>ğŸ“ˆ ì²´ê²° ë‚´ì—­</h5>
              {% if trades %}
              <table class="table table-sm table-dark">
                <thead>
                  <tr>
                    <th>ì‹œê°„</th><th>ë°©í–¥</th><th>ê°€ê²©</th><th>ìˆ˜ëŸ‰</th><th>ì†ìµ(PnL)</th>
                  </tr>
                </thead>
                <tbody>
                  {% for t in trades %}
                  <tr>
                    <td>{{ t.kst_time }}</td>
                    <td>{{ t.side }}</td>
                    <td>{{ t.price }}</td>
                    <td>{{ t.amount }}</td>
                    <td>{{ t.pnl }}</td>
                  </tr>
                  {% endfor %}
                </tbody>
              </table>
              {% else %}
              <p class="text-muted">ì²´ê²° ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</p>
              {% endif %}
            </div>
          </div>

          <div id="pane-bots" class="tab-pane fade">
            <div class="panel">
              <h5>ğŸ¤– ë™ì‘ì¤‘ì¸ ë´‡</h5>
              {% if bots %}
              <table class="table table-sm table-dark">
                <thead>
                  <tr>
                    <th>ì‹¬ë³¼</th><th>ë°©í–¥</th><th>ë ˆë²„ë¦¬ì§€</th><th>ìµì ˆ</th>
                  </tr>
                </thead>
                <tbody>
                  {% for b in bots %}
                  <tr>
                    <td>{{ b.symbol }}</td>
                    <td>{{ b.side }}</td>
                    <td>{{ b.leverage }}x</td>
                    <td>{{ b.take_profit }}</td>
                  </tr>
                  {% endfor %}
                </tbody>
              </table>
              {% else %}
              <p class="text-muted">ë™ì‘ ì¤‘ì¸ ë´‡ì´ ì—†ìŠµë‹ˆë‹¤.</p>
              {% endif %}
            </div>
          </div>

          <div id="pane-saved" class="tab-pane fade">
            <div class="panel">
              <h5>ğŸ’¾ ì„ì‹œì €ì¥ ì¢…ëª©</h5>
              {% if saved_configs %}
              <table class="table table-sm table-dark">
                <thead>
                  <tr>
                    <th>ì‹¬ë³¼</th><th>GAP</th><th>ê¸ˆì•¡</th>
                  </tr>
                </thead>
                <tbody>
                  {% for config in saved_configs %}
                  <tr>
                    <td>{{ config.symbol }}</td>
                    <td>{{ config.gap }}%</td>
                    <td>{{ config.amount }} USDT</td>
                  </tr>
                  {% endfor %}
                </tbody>
              </table>
              {% else %}
              <p class="text-muted">ì„ì‹œ ì €ì¥ëœ ì¢…ëª©ì´ ì—†ìŠµë‹ˆë‹¤.</p>
              {% endif %}
            </div>
          </div>

        </div>
      </div>
    </div>
  </div>

  <!-- jQuery & Bootstrap JS -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/js/bootstrap.bundle.min.js"></script>

  <!-- í† ìŠ¤íŠ¸ ìë™ ì‹¤í–‰ -->
  <script>
    $(function(){ $('.toast').toast('show'); });
  </script>

  <!-- âœ… AJAX ìœ í‹¸ + ë²„íŠ¼ í•¸ë“¤ëŸ¬ + ìƒíƒœ í´ë§ -->
  <script>
    // ê°„ë‹¨ í† ìŠ¤íŠ¸
    function showToast(msg, type) {
      const header = type === 'success' ? 'âœ… ì„±ê³µ'
                    : type === 'danger' ? 'âŒ ì˜¤ë¥˜'
                    : type === 'warning' ? 'âš ï¸ ê²½ê³ '
                    : 'â„¹ï¸ ì•Œë¦¼';
      const $toast = $(`
        <div class="toast" role="alert" aria-live="assertive" aria-atomic="true" data-delay="2500" style="pointer-events:auto;">
          <div class="toast-header">
            <strong class="mr-auto">${header}</strong>
            <small>ì§€ê¸ˆ</small>
            <button type="button" class="ml-2 mb-1 close" data-dismiss="toast"><span>&times;</span></button>
          </div>
          <div class="toast-body">${msg}</div>
        </div>`);
      $('#toast-container').append($toast);
      $toast.toast('show').on('hidden.bs.toast', function(){ $(this).remove(); });
    }

    // ê³µí†µ POST (form ë°ì´í„° ì§ë ¬í™” ì§€ì›)
    function postAjax(url, dataObj, onOK, onErr) {
      $.ajax({
        url: url,
        method: 'POST',
        data: dataObj || {},
        dataType: 'json'
      }).done(function(res){
        onOK && onOK(res);
      }).fail(function(xhr){
        const msg = (xhr.responseJSON && (xhr.responseJSON.error || xhr.responseJSON.message)) || 'ìš”ì²­ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜';
        onErr ? onErr(msg) : showToast(msg, 'danger');
      });
    }

    // ìƒíƒœ ë°°ì§€ ì—…ë°ì´íŠ¸
    function setStatusBadge(text) {
      const $b = $('#status-badge');
      $b.text(text || 'ëŒ€ê¸°ì¤‘');
      // í…ìŠ¤íŠ¸ì— ë”°ë¼ ìƒ‰ìƒ íŒíŠ¸ (ì˜µì…˜)
      const map = {
        'ì‹¤í–‰ì¤‘':'badge-success', 'ëŒ€ê¸°ì¤‘':'badge-info',
        'ì •ì§€':'badge-secondary', 'ì—ëŸ¬':'badge-danger'
      };
      $b.removeClass('badge-success badge-info badge-secondary badge-danger');
      for (const k in map) {
        if ((text||'').includes(k)) { $b.addClass(map[k]); return; }
      }
      $b.addClass('badge-info');
    }

    // /status_api í´ë§
    function pollStatus(){
      $.getJSON('/status_api')
       .done(function(res){
          // ì„œë²„ êµ¬í˜„ì— ë”°ë¼ í‚¤ê°€ status ë˜ëŠ” status_textì¼ ìˆ˜ ìˆì–´ ë‘˜ ë‹¤ ì²˜ë¦¬
          const s = res.status || res.status_text || res.state || '';
          if (s) setStatusBadge(s);
        });
    }

    // ë²„íŠ¼ enable/disable í¸ì˜
    function busy($btn, isBusy){
      $btn.prop('disabled', !!isBusy);
      $btn.toggleClass('disabled', !!isBusy);
    }

    $(function(){
      const $form = $('#settings-form');

      // ì €ì¥(ê¸°ë³¸ submit) â†’ AJAXë¡œ ë³€í™˜
      $('#save-btn').on('click', function(e){
        e.preventDefault();
        const $btn = $(this);
        busy($btn, true);
        const data = $form.serialize();
        postAjax('{{ url_for("main.index") }}', data, function(res){
          showToast('ì„¤ì •ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
          pollStatus(); // ì €ì¥ í›„ ìƒíƒœ ê°±ì‹ 
        }, function(msg){
          showToast(msg, 'danger');
        });
        busy($btn, false);
      });

      // ì‹œì‘
      $('#start-btn').on('click', function(){
        const $btn = $(this);
        busy($btn, true);
        const data = $form.serialize(); // ì‹œì‘ ì‹œ ì„¤ì •ê°’ë„ í•¨ê»˜ ì „ë‹¬í•˜ê³  ì‹¶ìœ¼ë©´ ì§ë ¬í™”
        postAjax('{{ url_for("main.start_bot") }}', data, function(res){
          const s = res.status || 'ë´‡ ì‹¤í–‰ ì¤‘';
          setStatusBadge(s);
          showToast('ë´‡ì„ ì‹œì‘í–ˆìŠµë‹ˆë‹¤.', 'success');
        }, function(msg){ showToast(msg, 'danger'); });
        busy($btn, false);
      });

      // ê·¸ë¦¬ë“œë§Œ ì¤‘ë‹¨
      $('#stop-grid-btn').on('click', function(){
        const $btn = $(this);
        busy($btn, true);
        postAjax('{{ url_for("main.stop_bot") }}', {}, function(res){
          setStatusBadge(res.status || 'ê·¸ë¦¬ë“œ ì¤‘ë‹¨');
          showToast('ê·¸ë¦¬ë“œë§Œ ì¤‘ë‹¨í–ˆìŠµë‹ˆë‹¤.', 'success');
        });
        busy($btn, false);
      });

      // ë°˜ë³µ ì •ì§€
      $('#stop-repeat-btn').on('click', function(){
        const $btn = $(this);
        busy($btn, true);
        postAjax('{{ url_for("main.stop_repeat") }}', {}, function(res){
          setStatusBadge(res.status || 'ë°˜ë³µ ì •ì§€');
          showToast('ë°˜ë³µì„ ì •ì§€í–ˆìŠµë‹ˆë‹¤.', 'success');
        });
        busy($btn, false);
      });

      // í¬ì§€ì…˜ ì²­ì‚° í›„ ì •ì§€
      $('#exit-stop-btn').on('click', function(){
        if (!confirm('ì •ë§ í¬ì§€ì…˜ì„ ì²­ì‚°í•˜ê³  ì •ì§€í• ê¹Œìš”?')) return;
        const $btn = $(this);
        busy($btn, true);
        postAjax('{{ url_for("main.exit_and_stop") }}', {}, function(res){
          setStatusBadge(res.status || 'ì²­ì‚° í›„ ì •ì§€');
          showToast('í¬ì§€ì…˜ì„ ì²­ì‚°í•˜ê³  ì •ì§€í–ˆìŠµë‹ˆë‹¤.', 'success');
        });
        busy($btn, false);
      });

      // ê°•ì œ ê°±ì‹  on/off/once
      $('#force-on-btn').on('click', function(){
        const $btn = $(this);
        busy($btn, true);
        postAjax('{{ url_for("main.force_refresh") }}', {}, function(){
          showToast('ì—°ì† ê°•ì œ ê°±ì‹  ON', 'success');
        });
        busy($btn, false);
      });
      $('#force-off-btn').on('click', function(){
        const $btn = $(this);
        busy($btn, true);
        postAjax('{{ url_for("main.clear_force_refresh") }}', {}, function(){
          showToast('ê°•ì œ ê°±ì‹  OFF', 'success');
        });
        busy($btn, false);
      });
      $('#force-once-btn').on('click', function(){
        const $btn = $(this);
        busy($btn, true);
        postAjax('{{ url_for("main.single_refresh") }}', {}, function(){
          showToast('í•œ ë²ˆë§Œ ê°±ì‹  ì‹¤í–‰', 'success');
        });
        busy($btn, false);
      });

      // 3ì´ˆë§ˆë‹¤ ìƒíƒœ í´ë§
      pollStatus();
      setInterval(pollStatus, 3000);
    });
  </script>

  <!-- ê·¸ë¦¬ë“œ ë Œë”ë§ (ê¸°ì¡´ê³¼ ë™ì¼) -->
  <script>
    function renderGrids() {
      const c = document.getElementById('gridContainer');
      if (!c) return;
      let initial = [];
      try {
        initial = JSON.parse(c.dataset.initialGrids || '[]');
      } catch (e) { console.warn('ê·¸ë¦¬ë“œ ì´ˆê¸°ê°’ íŒŒì‹± ì‹¤íŒ¨:', e); }
      const roundsEl = document.getElementById('roundsInput');
      const n = parseInt(roundsEl ? roundsEl.value : '0') || 0;
      c.innerHTML = '';
      let tot = 0;
      for (let i = 0; i < n; i++) {
        const a = initial[i]?.amount || '';
        const g = initial[i]?.gap || '';
        tot += parseFloat(a) || 0;
        const row = document.createElement('div');
        row.className = 'form-row mb-2';
        row.innerHTML = `
          <div class="col">
            <input type="text" name="amount${i+1}" value="${a}"
                   class="form-control form-control-sm"
                   placeholder="${i+1}íšŒì°¨ ê¸ˆì•¡(USDT)">
          </div>
          <div class="col">
            <input type="text" name="gap${i+1}" value="${g}"
                   class="form-control form-control-sm"
                   placeholder="${i+1}íšŒì°¨ GAP(%)">
          </div>`;
        c.appendChild(row);
      }
      const sumEl = document.getElementById('sumValue');
      if (sumEl) sumEl.textContent = tot.toFixed(2);
    }
    document.addEventListener('DOMContentLoaded', () => {
      renderGrids();
      const roundsEl = document.getElementById('roundsInput');
      if (roundsEl) roundsEl.addEventListener('input', renderGrids);
    });
  </script>
</body>
</html>
